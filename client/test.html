<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://unpkg.com/pdf-lib@1.11.0/dist/pdf-lib.min.js"></script>
    <script src="//mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
  </head>
  <style>
    .canvas {
      margin: auto;
      display: block;
      position: fixed;
      border: 1px solid #000;
      z-index: 3;
    }

    .sign {
      position: absolute;
      border: 1px solid;
      z-index: 2;
      user-select: none;
      cursor: pointer;
    }

    .page {
      width: max-content;
      margin: auto;
      position: relative;
    }

    .save {
      position: fixed;
      z-index: 4;
    }

    .page img {
      position: absolute;
      /* border: 1px solid #000; */
      left: 0;
      bottom: 0;
    }
  </style>
  <body>
    <canvas
      width="300px"
      height="100px"
      id="canvas"
      class="canvas"
    ></canvas>
    <button class="save" onclick="saveImg()">save</button>
  </body>

  <script>
    const dateCovert = (date) => {
      date = new Date(date);
      return (
        String(date.getMonth() + 1).padStart(2, "0") +
        "/" +
        String(date.getDate()).padStart(2, "0") +
        "/" +
        date.getFullYear()
      );
    };

    let { degrees, PDFDocument, rgb, StandardFonts } = PDFLib;

    async function modifyPdf() {
      const url =
        "https://raw.githubusercontent.com/valleyobformdocument/documents/main/1657474861786.pdf";
      const existingPdfBytes = await fetch(url).then((res) =>
        res.arrayBuffer()
      );

      const pdfDoc = await PDFDocument.load(existingPdfBytes);

      const form = pdfDoc.getForm();
      let fields = form.getFields();
      for (let i = 0; i < fields.length; i++) {
        console.log(fields[i].getName());
      }
      const dateField = form.getField("data");
      dateField.setText(dateCovert(new Date()));
      const pages = pdfDoc.getPages();
      const firstPage = pages[0];

      const pdfBytes = await pdfDoc.save();

      var pdfjsLib = window["pdfjs-dist/build/pdf"];

      // The workerSrc property shall be specified.
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "//mozilla.github.io/pdf.js/build/pdf.worker.js";

      // Asynchronous download of PDF
      var loadingTask = pdfjsLib.getDocument(pdfBytes);
      console.log(loadingTask);
      loadingTask.promise.then(
        function (pdf) {
          console.log("PDF loaded");
          console.log(pdf);
          for (let i = 0; i < pages.length; i++) {
            let page = document.createElement("div");
            page.setAttribute("class", "page");
            let canvas = document.createElement("canvas");
            let sign = document.createElement("div");
            sign.setAttribute("class", "sign");
            sign.setAttribute("onclick", `signShow(${i})`);
            sign.innerHTML = "add sign";
            page.append(canvas, sign);
            document.body.appendChild(page);
            pdf.getPage(i + 1).then(function (page) {
              console.log("Page loaded");

              var scale = 1.5;
              var viewport = page.getViewport({ scale: scale });

              // Prepare canvas using PDF page dimensions
              var context = canvas.getContext("2d");
              canvas.height = viewport.height;
              canvas.width = viewport.width;

              // Render PDF page into canvas context
              var renderContext = {
                canvasContext: context,
                viewport: viewport,
              };
              var renderTask = page.render(renderContext);
              renderTask.promise.then(function () {
                console.log("Page rendered");
              });
            });
          }
        },
        function (reason) {
          // PDF loading error
          console.error(reason);
        }
      );
    }

    modifyPdf();
  </script>

  <script>
    let signaturePad0, i0;
    const saveImg = async (x = 0, y = 0) => {
      const page0 = document.querySelectorAll(".page")[i0];
      let data = signaturePad0.toDataURL("image/png");
      let img = document.createElement("img");
      img.src = data;
      img.height = "75";
      //img.width = "300";

      const init = (e) => {
        // img.addEventListener("mousemove", setPosition);
        img.addEventListener("dragover", setPosition);
        img.style.top = e.pageY - 50 + "px";
        img.style.left = e.pageX - 300 + "px";
      };
      const setPosition = (e) => {
        let h = 0;
        if (i0) {
          for (let i = 0; i <= i0 - 1; i++) {
            h += Number(
              getComputedStyle(document.querySelectorAll(".page")[i])[
                "height"
              ].slice(0, -2)
            );
          }
        }
        console.log(h);
        img.style.top = e.pageY - 50 - h + "px";
        img.style.left = e.pageX - 300 + "px";
      };

      //const removeEv = () => {
      // img.removeEventListener("mousemove", setPosition);
      //img.removeEventListener("mousedown", init);
      // img.addEventListener("dragover", setPosition);
      //};

      //img.addEventListener("mousemove", setPosition);
      // img.addEventListener("mousedown", init);
      // img.addEventListener("mouseleave", removeEv);
      // img.addEventListener("mouseup", removeEv);
      // img.addEventListener("mouseout", removeEv);
      img.addEventListener("dragstart", setPosition);
      img.addEventListener("dragover", setPosition);
      page0.appendChild(img);
      return;
      {
        let page = document.querySelectorAll(".page");
        for (let x of page) {
          x.remove();
        }
      }

      const jpgImageBytes = await fetch(data).then((res) =>
        res.arrayBuffer()
      );

      const url =
        "https://raw.githubusercontent.com/valleyobformdocument/documents/main/1657573996891.pdf";
      const existingPdfBytes = await fetch(url).then((res) =>
        res.arrayBuffer()
      );

      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const jpgImage = await pdfDoc.embedPng(jpgImageBytes);

      const jpgDims = jpgImage.scale(0.5);

      const pages = pdfDoc.getPages();
      const page = pages[0];

      page.drawImage(jpgImage, {
        x: page.getWidth() - jpgDims.width - x,
        y: page.getHeight() - jpgDims.height - y,
        width: jpgDims.width,
        height: jpgDims.height,
      });

      const pdfBytes = await pdfDoc.save();

      var pdfjsLib = window["pdfjs-dist/build/pdf"];

      // The workerSrc property shall be specified.
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "//mozilla.github.io/pdf.js/build/pdf.worker.js";

      // Asynchronous download of PDF
      var loadingTask = pdfjsLib.getDocument(pdfBytes);
      loadingTask.promise.then(
        function (pdf) {
          console.log("PDF loaded");

          for (let i = 0; i < pages.length; i++) {
            let page = document.createElement("div");
            page.setAttribute("class", "page");
            let canvas = document.createElement("canvas");
            let sign = document.createElement("div");
            sign.setAttribute("class", "sign");
            sign.setAttribute("onclick", `signShow(${i})`);
            sign.innerHTML = "add sign";
            page.append(canvas, sign);
            document.body.appendChild(page);
            pdf.getPage(i + 1).then(function (page) {
              console.log("Page loaded");

              var scale = 1.5;
              var viewport = page.getViewport({ scale: scale });

              // Prepare canvas using PDF page dimensions
              var context = canvas.getContext("2d");
              canvas.height = viewport.height;
              canvas.width = viewport.width;

              // Render PDF page into canvas context
              var renderContext = {
                canvasContext: context,
                viewport: viewport,
              };
              var renderTask = page.render(renderContext);
              renderTask.promise.then(function () {
                console.log("Page rendered");
              });
            });
          }
        },
        function (reason) {
          // PDF loading error
          console.error(reason);
        }
      );
    };
    const signShow = async (i) => {
      const canvas = document.querySelector("#canvas");
      const signaturePad = new SignaturePad(canvas, {
        minWidth: 1,
        maxWidth: 1,
        penColor: "rgb(66, 133, 244)",
      });
      signaturePad0 = signaturePad;
      i0 = i;
    };
  </script>
</html>
